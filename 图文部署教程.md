# 📸 图文部署教程

这是一个配有详细说明的图文教程，每一步都有截图参考。

> **注意**：由于这是文本文档，实际截图需要你在操作时对照。下面的说明会告诉你每一步应该看到什么。

---

## 第一部分：准备工作

### 1.1 注册腾讯云账号

**访问**：https://cloud.tencent.com/

**操作步骤**：
1. 点击右上角"注册"
2. 使用微信扫码或手机号注册
3. 完成实名认证（需要身份证）

**预期结果**：
- 能够登录腾讯云控制台
- 实名认证状态显示"已认证"

---

### 1.2 注册GitHub账号

**访问**：https://github.com/

**操作步骤**：
1. 点击"Sign up"
2. 输入邮箱、密码
3. 验证邮箱

**预期结果**：
- 能够登录GitHub
- 看到GitHub首页

---

### 1.3 安装Git（Windows）

**下载地址**：https://git-scm.com/download/win

**操作步骤**：
1. 下载安装包（约50MB）
2. 双击运行安装程序
3. 全部使用默认选项，一直点"Next"
4. 安装完成后，右键桌面

**预期结果**：
- 右键菜单中能看到"Git Bash Here"选项
- 打开Git Bash，输入 `git --version` 能看到版本号

---

## 第二部分：上传代码到GitHub

### 2.1 创建GitHub仓库

**访问**：https://github.com/new

**操作步骤**：
1. Repository name 输入：`mt5-authorization-system`
2. Description 输入：`MT5 EA授权管理系统`
3. 选择 Public（公开）或 Private（私有，推荐）
4. ❌ **不要勾选** "Add a README file"
5. 点击"Create repository"

**预期结果**：
- 看到一个空仓库页面
- 页面上有"Quick setup"说明
- 有一个仓库地址，类似：`https://github.com/用户名/mt5-authorization-system.git`
- **复制这个地址，后面要用**

---

### 2.2 推送代码到GitHub

**操作步骤**：

1. 打开你的项目文件夹（sqwz1126）
2. 在文件夹空白处右键，选择"Git Bash Here"
3. 会打开一个黑色命令行窗口

**第一次使用Git，需要配置**：
```bash
git config --global user.name "你的名字"
git config --global user.email "你的邮箱"
```

**推送代码**：
```bash
# 1. 初始化仓库
git init

# 2. 添加所有文件
git add .

# 3. 提交
git commit -m "初始化MT5授权系统"

# 4. 添加远程仓库（替换成你的仓库地址）
git remote add origin https://github.com/你的用户名/mt5-authorization-system.git

# 5. 推送
git push -u origin master
```

**如果推送时要求登录**：
- 输入GitHub用户名
- 输入GitHub密码（或Personal Access Token）

**预期结果**：
- 命令执行成功，没有错误
- 刷新GitHub仓库页面，能看到所有代码文件
- 文件列表应该包含：
  - app/
  - lib/
  - package.json
  - README.md
  - 等等

---

## 第三部分：配置腾讯云服务

### 3.1 开通云开发

**访问**：https://console.cloud.tencent.com/tcb

**操作步骤**：

1. 如果是第一次使用，点击"立即开通"
2. 点击"新建环境"
3. 填写信息：
   - **环境名称**：`mt5-auth`（或其他名字）
   - **计费模式**：选择"按量计费"
   - 其他保持默认
4. 点击"立即开通"
5. 等待30秒-1分钟

**预期结果**：
- 看到环境列表，有一个新环境
- 环境状态显示"正常"
- **记下环境ID**（在环境名称下方，格式：mt5-auth-xxxxx）

**重要**：把环境ID复制到记事本，格式如下：
```
环境ID：mt5-auth-xxxxx
```

---

### 3.2 创建数据库集合

**操作步骤**：

1. 在云开发控制台，点击左侧"数据库"
2. 点击"添加集合"

**创建第一个集合**：
- 集合名称：`authorizations`
- 点击"确定"

**创建第二个集合**：
- 集合名称：`admins`
- 点击"确定"

**创建第三个集合**：
- 集合名称：`verification_logs`
- 点击"确定"

**预期结果**：
- 数据库页面显示3个集合
- 每个集合都是空的（0条记录）
- 集合列表：
  - authorizations
  - admins
  - verification_logs

---

## 第四部分：部署到Webify

### 4.1 访问Webify控制台

**访问**：https://console.cloud.tencent.com/webify

**操作步骤**：
1. 如果是第一次使用，点击"立即开通"（免费）
2. 同意服务协议
3. 开通成功后，进入控制台

**预期结果**：
- 看到Webify控制台
- 可以点击"新建应用"

---

### 4.2 创建应用

**操作步骤**：

1. 点击"新建应用"
2. 选择"从代码仓库导入"
3. 点击"授权GitHub账号"
4. 在弹出窗口登录GitHub并授权
5. 授权成功后，选择仓库：`mt5-authorization-system`
6. 点击"下一步"

**预期结果**：
- 能看到你的GitHub仓库列表
- 选中仓库后，显示仓库信息

---

### 4.3 配置构建设置

**Webify会自动识别项目类型**，你应该看到：

- **框架预设**：Next.js ✅
- **构建命令**：`npm run build` ✅
- **输出目录**：`.next` ✅
- **安装命令**：`npm install` ✅

**如果自动识别正确，直接点击"下一步"**

**如果没有自动识别，手动填写**：
- 框架预设：选择 Next.js
- Node.js版本：18.x
- 其他保持默认

---

### 4.4 配置环境变量（重要！）

**这是最关键的一步！**

点击"添加环境变量"，添加以下4个变量：

**变量1：JWT_SECRET**
```
名称：JWT_SECRET
值：abc123xyz789!@#$%^&*ABCDEFG
```
（这是示例，请改成你自己的随机字符串，越长越安全）

**变量2：TCB_ENV_ID**
```
名称：TCB_ENV_ID
值：mt5-auth-xxxxx
```
（填写你在3.1步骤记下的环境ID）

**变量3：DEFAULT_ADMIN_USERNAME**
```
名称：DEFAULT_ADMIN_USERNAME
值：admin
```
（这是管理员用户名，可以改）

**变量4：DEFAULT_ADMIN_PASSWORD**
```
名称：DEFAULT_ADMIN_PASSWORD
值：MySecurePass@123
```
（这是管理员密码，必须改成强密码）

**预期结果**：
- 环境变量列表显示4个变量
- 每个变量都有名称和值
- **把这4个变量复制到记事本保存**

---

### 4.5 开始部署

**操作步骤**：
1. 检查所有配置是否正确
2. 点击"完成"
3. 等待部署（3-5分钟）

**部署过程中你会看到**：
- 正在构建...
- 正在部署...
- 部署成功 ✅

**预期结果**：
- 部署状态显示"成功"
- 获得一个访问地址，类似：
  ```
  https://mt5-authorization-system-xxxxx.app.tcloudbase.com
  ```
- **复制这个地址到记事本**

---

## 第五部分：初始化和测试

### 5.1 初始化管理员账号

**方法1：使用浏览器控制台**

1. 打开浏览器，访问你的网站首页
2. 按 F12 打开开发者工具
3. 切换到"Console"（控制台）标签
4. 粘贴以下代码（记得替换域名）：

```javascript
fetch('https://你的域名.com/api/admin/init', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({})
})
.then(r => r.json())
.then(d => console.log(d))
```

5. 按回车执行

**预期结果**：
- 控制台显示：`{success: true, data: {username: "admin"}, message: "初始化成功..."}`

---

### 5.2 登录管理后台

**访问**：`https://你的域名.com/login`

**操作步骤**：
1. 输入用户名：`admin`（或你设置的用户名）
2. 输入密码：你在环境变量中设置的密码
3. 点击"登录"

**预期结果**：
- 登录成功，跳转到管理面板
- 看到授权管理界面
- 顶部显示"欢迎，admin"
- 看到4个统计卡片（都是0）
- 看到空的授权列表

---

### 5.3 测试添加授权

**操作步骤**：
1. 点击右上角"添加授权"按钮
2. 填写信息：
   - MT5账号：`12345678`
   - 授权时长：选择"自定义天数"
   - 天数：`30`
   - 备注：`测试账号`
3. 点击"确认"

**预期结果**：
- 弹出"授权添加成功"提示
- 授权列表中出现新记录
- 记录显示：
  - MT5账号：12345678
  - 状态：有效（绿色）
  - 剩余天数：30天
  - 可以看到"延期"和"取消"按钮

---

### 5.4 测试API验证

**访问**：`https://你的域名.com/api/verify?account=12345678`

**预期结果**：
浏览器显示JSON数据：
```json
{
  "success": true,
  "data": {
    "authorized": true,
    "account": "12345678",
    "expires_at": "2025-12-26T...",
    "is_permanent": false,
    "remaining_days": 30
  },
  "message": "授权有效",
  "timestamp": 1732608000
}
```

---

### 5.5 测试未授权账号

**访问**：`https://你的域名.com/api/verify?account=99999999`

**预期结果**：
```json
{
  "success": false,
  "data": {
    "authorized": false,
    "account": "99999999"
  },
  "message": "账号未授权",
  "timestamp": 1732608000
}
```

---

## 第六部分：配置MT5 EA

### 6.1 修改EA代码

**操作步骤**：
1. 用记事本打开 `MT5_EA_Authorization.mq5`
2. 找到第11行左右：
   ```mql5
   input string AuthServerURL = "https://your-domain.com/api/verify";
   ```
3. 修改为你的实际域名：
   ```mql5
   input string AuthServerURL = "https://你的域名.com/api/verify";
   ```
4. 保存文件

---

### 6.2 配置MT5允许WebRequest

**这一步非常重要！**

**操作步骤**：
1. 打开MT5软件
2. 点击菜单：**工具 -> 选项**
3. 选择 **"EA交易"** 标签
4. 找到 **"允许WebRequest访问以下URL"**
5. 勾选这个选项
6. 点击下方的 **"添加"** 按钮
7. 在弹出框输入：`https://你的域名.com`
8. 点击 **"确定"**
9. 再次点击 **"确定"** 保存设置
10. **重启MT5**

**预期结果**：
- URL列表中显示你的域名
- 复选框已勾选

**截图位置**：
```
工具 -> 选项 -> EA交易 -> 允许WebRequest访问以下URL
```

---

### 6.3 编译EA

**操作步骤**：
1. 在MT5中按 **F4** 打开MetaEditor
2. 点击菜单：**文件 -> 打开**
3. 找到并打开 `MT5_EA_Authorization.mq5`
4. 点击工具栏的 **"编译"** 按钮（或按F7）
5. 查看底部"工具箱"窗口

**预期结果**：
- 显示"0 error(s), 0 warning(s)"
- 编译成功
- 在MT5的"导航器"窗口能看到这个EA

---

### 6.4 测试EA（已授权）

**操作步骤**：
1. 在管理后台添加你的MT5账号授权
   - 获取你的MT5账号：在MT5中看账号信息
   - 在网站添加这个账号的授权
2. 在MT5中，从"导航器"拖动EA到图表
3. 在弹出的设置窗口，点击"确定"
4. 查看"专家"日志（Ctrl+T打开终端，选择"专家"标签）

**预期结果**：
日志显示：
```
========================================
MT5 EA授权系统
MT5账号: 你的账号
========================================
服务器响应: {"success":true,"data":{"authorized":true,...}}
验证时间已保存: 2025-11-26 10:30:00
✓ 授权验证成功 - 在线验证
```

EA图标显示笑脸 😊

---

### 6.5 测试EA（未授权）

**操作步骤**：
1. 使用一个未授权的MT5账号
2. 或者在管理后台取消当前账号的授权
3. 重新加载EA

**预期结果**：
- 弹出警告框："授权验证失败！此MT5账号未授权或授权已过期。EA将停止运行。"
- 日志显示："✗ 授权验证失败"
- EA无法启动

---

### 6.6 测试离线运行

**操作步骤**：
1. 确保EA已成功在线验证
2. 断开电脑网络（拔网线或关闭WiFi）
3. 重启EA

**预期结果**：
日志显示：
```
✓ 授权验证成功 - 离线模式
离线剩余时间: 23 小时
```

EA正常运行

---

## 🎉 部署完成检查清单

全部打勾表示部署成功：

- [ ] 代码已上传到GitHub
- [ ] 云开发环境已创建
- [ ] 3个数据库集合已创建
- [ ] Webify部署成功
- [ ] 获得访问域名
- [ ] 管理员账号已初始化
- [ ] 能够登录管理后台
- [ ] 能够添加授权
- [ ] API验证接口正常
- [ ] EA代码已修改域名
- [ ] MT5已允许WebRequest
- [ ] EA编译成功
- [ ] EA授权验证成功

---

## 📝 重要信息记录

**请把以下信息保存到安全的地方**：

```
=== 腾讯云信息 ===
云开发环境ID：_______________________________
Webify访问域名：_______________________________

=== 管理员账号 ===
用户名：_______________________________
密码：_______________________________

=== 环境变量 ===
JWT_SECRET：_______________________________

=== GitHub ===
仓库地址：_______________________________

=== 备注 ===
部署日期：_______________________________
```

---

## ❗ 常见错误和解决方法

### 错误1：Git推送失败

**错误信息**：
```
fatal: unable to access 'https://github.com/...': Failed to connect
```

**解决方法**：
- 检查网络连接
- 检查GitHub仓库地址是否正确
- 尝试使用VPN

---

### 错误2：Webify构建失败

**错误信息**：
```
Build failed
```

**解决方法**：
1. 点击查看"构建日志"
2. 检查环境变量是否都配置了
3. 检查代码是否完整上传到GitHub

---

### 错误3：无法登录管理后台

**错误信息**：
```
用户名或密码错误
```

**解决方法**：
1. 确认是否已执行初始化（访问 /api/admin/init）
2. 检查用户名密码是否与环境变量一致
3. 按F12查看浏览器控制台错误

---

### 错误4：EA提示"URL未被允许访问"

**错误信息**：
```
WebRequest错误: 4060
```

**解决方法**：
1. 打开MT5：工具 -> 选项 -> EA交易
2. 勾选"允许WebRequest访问以下URL"
3. 添加你的域名（包括 https://）
4. 重启MT5

---

### 错误5：EA无法连接服务器

**错误信息**：
```
HTTP请求失败，状态码: -1
```

**解决方法**：
- 检查网络连接
- 检查域名是否正确
- 检查MT5是否允许WebRequest
- 检查防火墙设置

---

## 🎯 下一步

部署成功后，建议：

1. **修改默认密码**
   - 在管理后台添加新管理员
   - 使用强密码

2. **添加真实授权**
   - 添加你的MT5账号
   - 设置合适的授权期限

3. **测试完整流程**
   - 测试授权验证
   - 测试延期功能
   - 测试取消功能

4. **备份重要信息**
   - 保存环境变量
   - 保存管理员密码
   - 定期导出数据库

5. **监控运行状态**
   - 定期查看授权列表
   - 查看验证日志
   - 监控Webify运行状态

---

**恭喜你完成部署！** 🎉

如果有任何问题，请查看：
- `README.md` - 项目说明
- `部署文档.md` - 详细部署文档
- `快速开始.md` - 快速开始指南
- `MT5_EA_使用说明.txt` - EA使用说明


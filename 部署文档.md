# 腾讯云 Webify 部署完整教程

本文档将一步步教你如何将MT5 EA授权系统部署到腾讯云 Webify。

## 📋 准备工作

### 1. 注册账号

- [ ] 注册腾讯云账号：https://cloud.tencent.com/
- [ ] 注册GitHub账号：https://github.com/
- [ ] 完成实名认证（腾讯云要求）

### 2. 安装工具

#### Windows用户：

1. **安装 Git**
   - 下载：https://git-scm.com/download/win
   - 双击安装，全部使用默认选项即可
   - 安装完成后，右键桌面，应该能看到"Git Bash Here"

2. **验证安装**
   - 右键桌面，选择"Git Bash Here"
   - 输入命令：`git --version`
   - 如果显示版本号，说明安装成功

## 📦 第一步：将代码上传到GitHub

### 1. 创建GitHub仓库

1. 登录 GitHub：https://github.com/
2. 点击右上角的 "+" 号，选择 "New repository"
3. 填写信息：
   - Repository name: `mt5-authorization-system`（或其他名字）
   - Description: `MT5 EA授权管理系统`
   - 选择 "Public"（公开）或 "Private"（私有）
   - ❌ **不要勾选** "Add a README file"
4. 点击 "Create repository"

### 2. 上传代码到GitHub

1. 在你的项目文件夹（sqwz1126）右键，选择 "Git Bash Here"

2. 依次执行以下命令：

```bash
# 初始化Git仓库
git init

# 添加所有文件
git add .

# 提交代码
git commit -m "初始化MT5授权系统"

# 添加远程仓库（替换成你的GitHub用户名和仓库名）
git remote add origin https://github.com/你的用户名/mt5-authorization-system.git

# 推送代码
git push -u origin master
```

**注意**：如果是第一次使用Git，需要先配置：
```bash
git config --global user.name "你的名字"
git config --global user.email "你的邮箱"
```

如果推送时要求登录，使用你的GitHub账号密码。

### 3. 验证上传成功

刷新GitHub仓库页面，应该能看到所有代码文件。

## ☁️ 第二步：开通腾讯云服务

### 1. 开通云开发（CloudBase）

1. 登录腾讯云控制台：https://console.cloud.tencent.com/
2. 搜索"云开发"或访问：https://console.cloud.tencent.com/tcb
3. 点击"新建环境"
4. 填写信息：
   - 环境名称：`mt5-auth`（或其他名字）
   - 计费模式：选择"按量计费"（有免费额度）
   - 环境ID：自动生成，**记下这个ID**（例如：mt5-auth-xxx）
5. 点击"立即开通"

### 2. 创建数据库集合

1. 在云开发控制台，点击左侧"数据库"
2. 点击"添加集合"，创建以下三个集合：
   - `authorizations`（授权表）
   - `admins`（管理员表）
   - `verification_logs`（验证日志表）
3. 每个集合的权限设置为"仅管理端可读写"

### 3. 获取云开发密钥（可选，用于本地开发）

1. 点击左侧"设置"
2. 点击"环境变量"
3. 记下环境ID（TCB_ENV_ID）

## 🚀 第三步：部署到Webify

### 1. 访问Webify控制台

访问：https://console.cloud.tencent.com/webify

如果是第一次使用，需要开通服务（免费）。

### 2. 创建应用

1. 点击"新建应用"
2. 选择"从代码仓库导入"
3. 授权GitHub账号
4. 选择你刚才创建的仓库：`mt5-authorization-system`
5. 点击"下一步"

### 3. 配置构建设置

Webify会自动识别Next.js项目，配置如下：

- **框架预设**：Next.js
- **构建命令**：`npm run build`（自动填充）
- **输出目录**：`.next`（自动填充）
- **安装命令**：`npm install`（自动填充）

点击"下一步"。

### 4. 配置环境变量

这是最重要的一步！点击"添加环境变量"，添加以下变量：

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `JWT_SECRET` | `your-random-secret-key-123456` | JWT密钥，请改成随机字符串 |
| `TCB_ENV_ID` | `mt5-auth-xxx` | 你的云开发环境ID |
| `DEFAULT_ADMIN_USERNAME` | `admin` | 默认管理员用户名 |
| `DEFAULT_ADMIN_PASSWORD` | `admin123456` | 默认管理员密码（建议改复杂点） |

**重要提示**：
- `JWT_SECRET` 必须是随机字符串，建议至少32位
- `TCB_ENV_ID` 必须是你刚才创建的云开发环境ID
- 密码建议设置复杂一些

### 5. 开始部署

1. 点击"完成"
2. Webify会自动开始构建和部署
3. 等待3-5分钟（第一次部署会比较慢）
4. 部署成功后，会显示访问地址

### 6. 获取访问地址

部署成功后，你会得到一个地址，例如：
```
https://mt5-authorization-system-xxx.app.tcloudbase.com
```

**记下这个地址**，后面会用到！

## 🔧 第四步：初始化系统

### 1. 初始化管理员账号

打开浏览器，访问：
```
https://你的域名.com/api/admin/init
```

使用POST请求（可以用浏览器插件如Postman，或者直接访问会返回初始化状态）。

或者使用以下方法：

1. 打开浏览器开发者工具（F12）
2. 切换到"Console"标签
3. 粘贴以下代码并回车：

```javascript
fetch('https://你的域名.com/api/admin/init', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({})
})
.then(r => r.json())
.then(d => console.log(d))
```

如果返回 `{"success": true, ...}`，说明初始化成功。

### 2. 登录管理后台

访问：`https://你的域名.com/login`

使用默认账号登录：
- 用户名：`admin`（或你设置的用户名）
- 密码：`admin123456`（或你设置的密码）

登录成功后，应该能看到授权管理面板。

## ✅ 第五步：配置MT5 EA

### 1. 修改EA代码

1. 打开 `MT5_EA_Authorization.mq5`
2. 找到这一行：
   ```mql5
   input string AuthServerURL = "https://your-domain.com/api/verify";
   ```
3. 修改为你的实际域名：
   ```mql5
   input string AuthServerURL = "https://你的域名.com/api/verify";
   ```

### 2. 在MT5中配置WebRequest

这一步非常重要！

1. 打开MT5
2. 菜单：**工具 -> 选项**
3. 选择 **"EA交易"** 标签
4. 勾选 **"允许WebRequest访问以下URL"**
5. 点击 **"添加"**，输入：
   ```
   https://你的域名.com
   ```
6. 点击 **"确定"** 保存
7. **重启MT5**

### 3. 编译EA

1. 在MT5中按 **F4** 打开MetaEditor
2. 打开 `MT5_EA_Authorization.mq5`
3. 点击 **"编译"** 按钮（或按F7）
4. 确保没有错误

### 4. 测试EA

1. 在管理后台添加你的MT5账号授权
2. 在MT5中加载EA到图表
3. 查看"专家"日志，应该看到"授权验证成功"

## 🎯 第六步：测试系统

### 测试1：添加授权

1. 登录管理后台
2. 点击"添加授权"
3. 输入MT5账号：`12345678`
4. 选择授权时长：`30`天
5. 点击确认
6. 应该能在列表中看到新添加的授权

### 测试2：EA验证

在浏览器访问：
```
https://你的域名.com/api/verify?account=12345678
```

应该返回：
```json
{
  "success": true,
  "data": {
    "authorized": true,
    "account": "12345678",
    ...
  }
}
```

### 测试3：未授权账号

访问：
```
https://你的域名.com/api/verify?account=99999999
```

应该返回：
```json
{
  "success": false,
  "data": {
    "authorized": false
  },
  "message": "账号未授权"
}
```

## 🔄 后续更新代码

如果你修改了代码，更新步骤：

1. 在项目文件夹打开Git Bash
2. 执行命令：
   ```bash
   git add .
   git commit -m "更新说明"
   git push
   ```
3. Webify会自动检测到更新并重新部署

## 🌐 绑定自定义域名（可选）

如果你有自己的域名：

1. 在Webify控制台，点击你的应用
2. 点击"设置" -> "自定义域名"
3. 添加你的域名
4. 按照提示配置DNS解析
5. 等待SSL证书自动签发

## 📊 监控和维护

### 查看日志

1. 在Webify控制台，点击"日志"
2. 可以看到应用运行日志和错误信息

### 查看数据库

1. 在云开发控制台，点击"数据库"
2. 可以查看和管理所有数据

### 查看访问统计

1. 在Webify控制台，点击"监控"
2. 可以看到访问量、响应时间等数据

## ❗ 常见问题

### Q1: 部署失败怎么办？

**A**: 查看构建日志：
1. 在Webify控制台，点击失败的部署
2. 查看"构建日志"
3. 根据错误信息修复代码
4. 重新推送代码

### Q2: 无法连接数据库？

**A**: 检查：
- 环境变量 `TCB_ENV_ID` 是否正确
- 云开发环境是否正常运行
- 数据库集合是否已创建

### Q3: EA无法连接服务器？

**A**: 检查：
- MT5是否允许WebRequest访问你的域名
- 域名地址是否正确（包括https://）
- 网络是否正常

### Q4: 忘记管理员密码？

**A**: 
1. 在云开发控制台，打开数据库
2. 找到 `admins` 集合
3. 删除现有管理员记录
4. 重新访问 `/api/admin/init` 初始化

### Q5: 如何备份数据？

**A**:
1. 在云开发控制台，点击"数据库"
2. 选择集合，点击"导出"
3. 下载JSON文件保存

## 📞 获取帮助

如果遇到问题：

1. 查看本文档的"常见问题"部分
2. 查看Webify构建日志
3. 查看浏览器控制台错误信息
4. 查看MT5专家日志

## 🎉 完成！

恭喜你！现在你已经成功部署了MT5 EA授权管理系统。

**重要提醒**：
- ⚠️ 立即修改默认管理员密码
- 🔒 定期备份数据库
- 📝 定期查看验证日志
- 🔐 保管好环境变量中的密钥

祝你使用愉快！

